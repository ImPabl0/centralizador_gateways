<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Teste SSE - Gateway Payments</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
        line-height: 1.6;
      }
      .container {
        background: #f4f4f4;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
      }
      .log-container {
        background: #1e1e1e;
        color: #00ff00;
        padding: 15px;
        border-radius: 5px;
        height: 300px;
        overflow-y: auto;
        font-family: "Courier New", monospace;
        font-size: 12px;
      }
      button {
        background: #007cba;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #005a82;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      input {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin: 5px;
      }
      .status {
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
      }
      .status.connected {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .status.disconnected {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .gateway-section {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        margin: 15px 0;
      }
      .gateway-section h3 {
        margin-top: 0;
        color: #333;
      }
    </style>
  </head>
  <body>
    <h1>üöÄ Teste de SSE - Gateway Payments</h1>

    <div class="gateway-section">
      <h3>üì° PayEvo Gateway</h3>
      <div>
        <input
          type="text"
          id="payevoPaymentId"
          placeholder="ID do Pagamento PayEvo"
          value=""
        />
        <button id="connectPayevo" onclick="connectPayEvo()">
          Conectar SSE PayEvo
        </button>
        <button id="disconnectPayevo" onclick="disconnectPayEvo()" disabled>
          Desconectar
        </button>
      </div>
      <div id="payevoStatus" class="status disconnected">‚ùå Desconectado</div>
    </div>

    <div class="gateway-section">
      <h3>üê± BlackCat Gateway</h3>
      <div>
        <input
          type="text"
          id="blackcatPaymentId"
          placeholder="ID do Pagamento BlackCat"
          value=""
        />
        <button id="connectBlackcat" onclick="connectBlackCat()">
          Conectar SSE BlackCat
        </button>
        <button id="disconnectBlackcat" onclick="disconnectBlackCat()" disabled>
          Desconectar
        </button>
      </div>
      <div id="blackcatStatus" class="status disconnected">‚ùå Desconectado</div>
    </div>

    <div class="container">
      <h3>üìä Estat√≠sticas das Conex√µes</h3>
      <button onclick="getStats()">Atualizar Estat√≠sticas</button>
      <div id="stats"></div>
    </div>

    <div class="container">
      <h3>üìù Logs de Eventos</h3>
      <button onclick="clearLogs()">Limpar Logs</button>
      <div id="logs" class="log-container"></div>
    </div>

    <script>
      let payevoEventSource = null;
      let blackcatEventSource = null;
      const baseUrl = "http://localhost:5000"; // Altere conforme necess√°rio

      function log(message, type = "info") {
        const timestamp = new Date().toLocaleTimeString();
        const logElement = document.getElementById("logs");
        const prefix =
          type === "error" ? "‚ùå" : type === "success" ? "‚úÖ" : "‚ÑπÔ∏è";
        logElement.innerHTML += `[${timestamp}] ${prefix} ${message}\n`;
        logElement.scrollTop = logElement.scrollHeight;
      }

      function updateStatus(gateway, connected, connectionId = null) {
        const statusElement = document.getElementById(`${gateway}Status`);
        const connectButton = document.getElementById(
          `connect${gateway.charAt(0).toUpperCase() + gateway.slice(1)}`
        );
        const disconnectButton = document.getElementById(
          `disconnect${gateway.charAt(0).toUpperCase() + gateway.slice(1)}`
        );

        if (connected) {
          statusElement.className = "status connected";
          statusElement.textContent = `‚úÖ Conectado${
            connectionId ? ` (${connectionId})` : ""
          }`;
          connectButton.disabled = true;
          disconnectButton.disabled = false;
        } else {
          statusElement.className = "status disconnected";
          statusElement.textContent = "‚ùå Desconectado";
          connectButton.disabled = false;
          disconnectButton.disabled = true;
        }
      }

      function connectPayEvo() {
        const paymentId = document
          .getElementById("payevoPaymentId")
          .value.trim();
        if (!paymentId) {
          alert("Por favor, informe o ID do pagamento PayEvo");
          return;
        }

        if (payevoEventSource) {
          payevoEventSource.close();
        }

        log(`Conectando ao SSE PayEvo para pagamento: ${paymentId}`);

        payevoEventSource = new EventSource(
          `${baseUrl}/pix/sse/payevo/${paymentId}`
        );

        payevoEventSource.onopen = function (event) {
          log("Conex√£o SSE PayEvo estabelecida com sucesso", "success");
          updateStatus("payevo", true);
        };

        payevoEventSource.onmessage = function (event) {
          try {
            const data = JSON.parse(event.data);
            log(
              `üì° Evento PayEvo recebido: ${JSON.stringify(data, null, 2)}`,
              "success"
            );

            if (data.type === "connection_established") {
              updateStatus("payevo", true, data.connectionId);
            }
          } catch (error) {
            log(`Erro ao processar evento PayEvo: ${error.message}`, "error");
          }
        };

        payevoEventSource.onerror = function (event) {
          log("Erro na conex√£o SSE PayEvo", "error");
          updateStatus("payevo", false);
          payevoEventSource = null;
        };
      }

      function disconnectPayEvo() {
        if (payevoEventSource) {
          payevoEventSource.close();
          payevoEventSource = null;
          log("Conex√£o SSE PayEvo desconectada");
          updateStatus("payevo", false);
        }
      }

      function connectBlackCat() {
        const paymentId = document
          .getElementById("blackcatPaymentId")
          .value.trim();
        if (!paymentId) {
          alert("Por favor, informe o ID do pagamento BlackCat");
          return;
        }

        if (blackcatEventSource) {
          blackcatEventSource.close();
        }

        log(`Conectando ao SSE BlackCat para pagamento: ${paymentId}`);

        blackcatEventSource = new EventSource(
          `${baseUrl}/pix/sse/blackcat/${paymentId}`
        );

        blackcatEventSource.onopen = function (event) {
          log("Conex√£o SSE BlackCat estabelecida com sucesso", "success");
          updateStatus("blackcat", true);
        };

        blackcatEventSource.onmessage = function (event) {
          try {
            const data = JSON.parse(event.data);
            log(
              `üê± Evento BlackCat recebido: ${JSON.stringify(data, null, 2)}`,
              "success"
            );

            if (data.type === "connection_established") {
              updateStatus("blackcat", true, data.connectionId);
            }
          } catch (error) {
            log(`Erro ao processar evento BlackCat: ${error.message}`, "error");
          }
        };

        blackcatEventSource.onerror = function (event) {
          log("Erro na conex√£o SSE BlackCat", "error");
          updateStatus("blackcat", false);
          blackcatEventSource = null;
        };
      }

      function disconnectBlackCat() {
        if (blackcatEventSource) {
          blackcatEventSource.close();
          blackcatEventSource = null;
          log("Conex√£o SSE BlackCat desconectada");
          updateStatus("blackcat", false);
        }
      }

      async function getStats() {
        try {
          const response = await fetch(`${baseUrl}/pix/sse/stats`);
          const stats = await response.json();

          document.getElementById("stats").innerHTML = `
                    <h4>Conex√µes Ativas: ${stats.totalConnections}</h4>
                    <h4>Por Gateway:</h4>
                    <ul>
                        ${Object.entries(stats.connectionsByGateway)
                          .map(
                            ([gateway, count]) =>
                              `<li>${gateway}: ${count} conex√µes</li>`
                          )
                          .join("")}
                    </ul>
                    <h4>Por Pagamento:</h4>
                    <ul>
                        ${Object.entries(stats.connectionsByPayment)
                          .map(
                            ([payment, count]) =>
                              `<li>${payment}: ${count} conex√µes</li>`
                          )
                          .join("")}
                    </ul>
                `;

          log("Estat√≠sticas atualizadas com sucesso", "success");
        } catch (error) {
          log(`Erro ao obter estat√≠sticas: ${error.message}`, "error");
        }
      }

      function clearLogs() {
        document.getElementById("logs").innerHTML = "";
      }

      // Cleanup ao fechar a p√°gina
      window.addEventListener("beforeunload", function () {
        if (payevoEventSource) {
          payevoEventSource.close();
        }
        if (blackcatEventSource) {
          blackcatEventSource.close();
        }
      });

      // Log inicial
      log(
        'Cliente SSE iniciado. Configure os IDs dos pagamentos e clique em "Conectar".'
      );
    </script>
  </body>
</html>
